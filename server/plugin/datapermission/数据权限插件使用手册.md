# 数据权限管理插件使用手册

## 📖 目录

- [插件简介](#插件简介)
- [功能特性](#功能特性)
- [安装配置](#安装配置)
- [使用方法](#使用方法)
- [API接口](#api接口)
- [代码示例](#代码示例)
- [常见问题](#常见问题)
- [最佳实践](#最佳实践)

## 🚀 插件简介

数据权限管理插件是专为 gin-vue-admin 框架开发的企业级数据权限控制解决方案。通过灵活的角色树管理、细粒度的数据范围控制和字段级权限管理，帮助企业构建安全、高效的数据访问控制体系。

### 核心概念

- **受控表（ControlledTable）**: 需要进行权限控制的数据库表
- **数据范围（DataScope）**: 控制用户可以访问的数据范围（全部、部门、个人等）
- **字段权限（FieldPermission）**: 控制字段的可见性、编辑权限、导出权限、查询权限
- **角色权限（RolePermission）**: 基于角色的权限配置

## ✨ 功能特性

### 数据权限控制
- 🌳 **角色树管理** - 与系统角色保持一致的层级结构
- 🔐 **数据范围控制** - 支持全部、本部门、本部门及子部门、仅本人、自定义等多种数据范围
- 🏷️ **字段级权限** - 精确控制用户可见的数据字段
- 📊 **受控表管理** - 动态配置需要权限控制的数据表

### 安全特性
- 🛡️ **SQL注入防护** - 内置SQL注入检查，确保数据安全
- ⚡ **高性能缓存** - 智能缓存机制，提升权限检查效率
- 📝 **操作日志** - 完整的权限操作审计日志

### 技术特性
- 🔄 **自动拦截** - 基于GORM拦截器的自动权限控制
- 🎯 **零侵入** - 业务代码无需修改，自动应用权限
- 🔧 **灵活配置** - 支持多种配置方式和自定义扩展

## 🛠️ 安装配置

### 环境要求
- **后端**: Go 1.19+, gin-vue-admin v2.5.0+
- **前端**: Vue 3.0+, Element Plus 2.0+
- **数据库**: MySQL 5.7+ / PostgreSQL 12+ / SQLite 3.0+

### 插件结构

#### 后端文件结构
```
server/plugin/datapermission/
├── api/                    # API接口层
│   ├── data_permission.go  # 数据权限API
│   └── enter.go           # API入口
├── model/                  # 数据模型
│   ├── model.go           # 核心模型定义
│   ├── request/           # 请求模型
│   └── response/          # 响应模型
├── service/                # 业务逻辑层
│   ├── data_permission.go  # 数据权限服务
│   └── enter.go           # 服务入口
├── router/                 # 路由配置
│   ├── data_permission.go  # 权限路由
│   └── enter.go           # 路由入口
├── utils/                  # 工具类
│   ├── interceptor.go     # 数据权限拦截器
│   ├── middleware.go      # 中间件
│   ├── permission.go      # 权限助手
│   └── enhanced_helper.go # 增强助手
├── config/                 # 配置文件
│   ├── config.go          # 配置结构
│   └── config.yaml        # 配置文件
├── global/                 # 全局变量
│   └── global.go          # 全局定义
└── plugin.go              # 插件注册
```

#### 前端文件结构
```
web/src/plugin/datapermission/
├── api/                    # API接口
│   └── dataPermission.js  # 数据权限API
├── components/             # 组件库
│   ├── RoleTree.vue       # 角色树组件
│   └── DataPermissionConfig.vue # 权限配置组件
├── view/                   # 页面视图
│   └── index.vue          # 主页面
├── router/                 # 路由配置
│   └── index.js           # 路由定义
├── index.js               # 插件入口
└── README.md              # 组件文档
```

### 配置文件

#### 后端配置 (config.yaml)
```yaml
# 数据权限插件配置
datapermission:
  enabled: true                    # 是否启用插件
  default-data-scope: self         # 默认数据范围
  field-permission-enabled: true   # 是否启用字段权限
  sql-injection-check: true        # 是否检查SQL注入
  cache:
    enabled: true                  # 是否启用缓存
    expiration: 300               # 缓存过期时间（秒）
    key-prefix: "data_permission:" # 缓存键前缀
  log:
    enabled: true                  # 是否启用日志
    level: info                   # 日志级别
    log-sql: true                 # 是否记录SQL

# 插件路由配置
router:
  prefix: "/api/datapermission"    # 路由前缀
  
# 数据库表配置
database:
  auto-migrate: true               # 是否自动迁移
  tables:
    - controlled_table             # 受控表
    - role_data_permission         # 角色数据权限
    - role_field_permission        # 角色字段权限
```

## 📋 使用方法
### 1. 需要修改的代码

server/middleware/casbin_rbac.go

CasbinHandler  在c.Set("userID", waitUse.BaseClaims.ID) 上方增加  c.Set("authorityIds", waitUse.AuthorityIds)

server/model/system/request/jwt.go
BaseClaims 增加
AuthorityIds []uint

### 2. 路由中间件配置

在需要数据权限控制的路由中添加中间件：

```go
// 推荐方式：使用自动拦截器中间件
import perUtil "github.com/flipped-aurora/gin-vue-admin/server/plugin/datapermission/utils"

func (s *UserRouter) InitUserRouter(Router *gin.RouterGroup) {
    // 使用数据权限自动中间件
    userRouter := Router.Group("user").Use(perUtil.DataPermissionAutoMiddleware())
    userRouterWithoutRecord := Router.Group("user").Use(perUtil.DataPermissionAutoMiddleware())
    
    {
        userRouter.POST("admin_register", baseApi.Register)
        userRouter.POST("changePassword", baseApi.ChangePassword)
        userRouter.DELETE("deleteUser", baseApi.DeleteUser)
        // ... 其他需要权限控制的接口
    }
    {
        userRouterWithoutRecord.POST("getUserList", baseApi.GetUserList) // 分页获取用户列表
        userRouterWithoutRecord.GET("getUserInfo", baseApi.GetUserInfo)   // 获取自身信息
    }
}
```

### 3. 数据库操作

#### 自动权限控制（推荐）

使用拦截器中间件后，所有数据库操作会自动应用权限：

```go
// 在API处理函数中
func (userApi *UserApi) GetUserList(c *gin.Context) {
    // 获取带有拦截器的数据库实例
    db := perUtil.GetInterceptorDB(c)
    
    var users []system.SysUser
    // 自动应用数据权限，用户只能看到有权限的数据
    err := db.Find(&users).Error
    if err != nil {
        response.FailWithMessage("查询失败", c)
        return
    }
    
    response.OkWithData(users, c)
}
```

#### 手动权限控制

如果需要手动控制权限：

```go
func (userApi *UserApi) GetUserList(c *gin.Context) {
    db := global.GVA_DB.Model(&system.SysUser{})
    
    // 手动应用数据权限
    db = perUtil.PermissionHelperApp.ApplyDataPermissionToQuery(db, c, "sys_users")
    
    var users []system.SysUser
    err := db.Find(&users).Error
    if err != nil {
        response.FailWithMessage("查询失败", c)
        return
    }
    
    // 手动应用字段权限过滤
    filteredUsers := perUtil.PermissionHelperApp.FilterFieldsByPermission(c, users, "sys_users", "view")
    
    response.OkWithData(filteredUsers, c)
}
```

#### 跳过权限检查

在某些系统操作中需要跳过权限检查：

```go
// 跳过数据权限检查
db := perUtil.SkipDataPermission(global.GVA_DB)
var allUsers []system.SysUser
db.Find(&allUsers)

// 标记为系统操作
db = perUtil.SetSystemOperation(global.GVA_DB)
var systemUsers []system.SysUser
db.Find(&systemUsers)
```

### 3. 前端配置界面

#### 路由配置

在主应用的路由配置中引入插件路由：

```javascript
// router/index.js
import DataPermissionRouter from '@/plugin/datapermission/router/index'

const routes = [
  {
    path: '/admin',
    component: Layout,
    children: [DataPermissionRouter]
  }
]
```

#### 组件使用

```vue
<template>
  <div class="data-permission-page">
    <!-- 角色树组件 -->
    <RoleTree @role-selected="handleRoleSelected" ref="roleTreeRef" />
    
    <!-- 数据权限配置组件 -->
    <DataPermissionConfig 
      v-if="selectedRole" 
      :current-role="selectedRole" 
      :key="selectedRole.authorityId"
    />
  </div>
</template>

<script setup>
import { ref } from 'vue'
import RoleTree from '@/plugin/datapermission/components/RoleTree.vue'
import DataPermissionConfig from '@/plugin/datapermission/components/DataPermissionConfig.vue'

const selectedRole = ref(null)

const handleRoleSelected = (role) => {
  selectedRole.value = role
}
</script>
```

## 🔌 API接口

### 数据权限配置相关

```javascript
// 获取数据权限配置
export const getDataPermissionConfig = (data) => {
  return service({
    url: '/datapermission/getConfig?tableName=' + data.tableName + '&authorityId=' + data.authorityID,
    method: 'get',
  })
}

// 保存数据权限配置
export const saveDataPermissionConfig = (data) => {
  return service({
    url: '/datapermission/saveConfig',
    method: 'post',
    data
  })
}

// 获取数据库表列表
export const getDatabaseTables = () => {
  return service({
    url: '/datapermission/tableList',
    method: 'get'
  })
}

// 获取表字段信息
export const getTableColumns = (tableName) => {
  return service({
    url: '/datapermission/fieldList',
    method: 'get',
    params: { tableName }
  })
}
```

### 受控表管理相关

```javascript
// 获取受控表列表
export const getControlledTables = () => {
  return service({
    url: '/datapermission/controlledTableList',
    method: 'get'
  })
}

// 创建受控表
export const createControlledTable = (data) => {
  return service({
    url: '/datapermission/controlledTable',
    method: 'post',
    data
  })
}

// 删除受控表
export const deleteControlledTable = (data) => {
  return service({
    url: '/datapermission/controlledTable',
    method: 'delete',
    data
  })
}
```

## 💡 代码示例

### 示例1：用户管理模块权限控制

```go
// 用户路由配置
func (s *UserRouter) InitUserRouter(Router *gin.RouterGroup) {
    userRouter := Router.Group("user").Use(perUtil.DataPermissionAutoMiddleware())
    userRouterWithoutRecord := Router.Group("user").Use(perUtil.DataPermissionAutoMiddleware())
    
    {
        userRouter.DELETE("deleteUser", baseApi.DeleteUser)               // 删除用户
        userRouter.PUT("setUserInfo", baseApi.SetUserInfo)                // 设置用户信息
    }
    {
        userRouterWithoutRecord.POST("getUserList", baseApi.GetUserList) // 分页获取用户列表
        userRouterWithoutRecord.GET("getUserInfo", baseApi.GetUserInfo)  // 获取自身信息
    }
}

// 用户API实现
func (userApi *UserApi) GetUserList(c *gin.Context) {
    var pageInfo request.PageInfo
    err := c.ShouldBindJSON(&pageInfo)
    if err != nil {
        response.FailWithMessage(err.Error(), c)
        return
    }
    
    // 获取带有拦截器的数据库实例，自动应用数据权限
    db := perUtil.GetInterceptorDB(c)
    
    userList, total, err := userService.GetUserInfoList(pageInfo, db)
    if err != nil {
        global.GVA_LOG.Error("获取失败!", zap.Error(err))
        response.FailWithMessage("获取失败", c)
        return
    }
    
    response.OkWithDetailed(response.PageResult{
        List:     userList,
        Total:    total,
        Page:     pageInfo.Page,
        PageSize: pageInfo.PageSize,
    }, "获取成功", c)
}
```

### 示例2：数据范围配置

```yaml
# 配置示例：不同角色的数据范围

# 超级管理员 - 查看所有数据
role: admin
data_scope: all
custom_condition: "1=1"

# 部门管理员 - 查看本部门及子部门数据
role: dept_admin
data_scope: dept_and_children
custom_condition: "dept_id IN (SELECT id FROM sys_dept WHERE dept_path LIKE CONCAT((SELECT dept_path FROM sys_dept WHERE id = ?), '%'))"

# 普通用户 - 只查看自己的数据
role: user
data_scope: self
custom_condition: "created_by = ?"
```

### 示例3：字段权限配置

```javascript
// 前端字段权限配置示例
const fieldPermissions = {
  // 用户表字段权限
  sys_users: {
    username: { visible: true, editable: false, exportable: true, queryable: true },
    password: { visible: false, editable: false, exportable: false, queryable: false },
    phone: { visible: true, editable: true, exportable: true, queryable: true },
    email: { visible: true, editable: true, exportable: true, queryable: true },
    salary: { visible: false, editable: false, exportable: false, queryable: false }
  }
}
```

## ❓ 常见问题

### Q1: 插件安装后无法访问页面？
**A**: 请检查以下几点：
1. 确认路由配置是否正确添加到主路由文件中
2. 检查用户是否有访问权限
3. 确认插件是否正确注册

### Q2: 权限配置不生效？
**A**: 请检查：
1. 中间件是否正确配置
2. 受控表是否已添加并启用
3. 角色权限配置是否正确
4. 清除权限缓存后重新测试

### Q3: 数据库迁移失败？
**A**: 请确保：
1. 数据库连接正常
2. 用户具有创建表的权限
3. 检查数据库版本兼容性

### Q4: 如何调试权限问题？
**A**: 可以通过以下方式调试：
1. 启用SQL日志查看生成的权限条件
2. 使用 `SkipDataPermission` 跳过权限检查对比结果
3. 检查用户角色和权限配置

### Q5: 性能优化建议？
**A**: 
1. 启用权限缓存
2. 合理设置缓存过期时间
3. 避免过于复杂的自定义SQL条件
4. 定期清理无用的权限配置

## 🎯 最佳实践

### 1. 权限设计原则
- **最小权限原则**: 用户只能访问完成工作所需的最少数据
- **职责分离**: 不同角色具有不同的数据访问权限
- **权限继承**: 子角色可以继承父角色的权限

### 2. 配置建议
- **统一使用拦截器**: 推荐使用 `DataPermissionAutoMiddleware()` 实现自动权限控制
- **合理设置缓存**: 根据业务需求设置合适的缓存过期时间
- **定期审计**: 定期检查和清理权限配置

### 3. 开发建议
- **测试覆盖**: 为权限相关功能编写充分的测试用例
- **日志记录**: 启用权限操作日志，便于问题排查
- **文档维护**: 及时更新权限配置文档

### 4. 安全建议
- **SQL注入防护**: 启用SQL注入检查
- **敏感字段保护**: 对敏感字段设置严格的访问权限
- **操作审计**: 记录所有权限相关的操作日志

---

## 📞 技术支持

如果在使用过程中遇到问题，可以通过以下方式获取帮助：

1. **查看日志**: 检查应用日志和数据库日志
2. **官方文档**: 参考 gin-vue-admin 官方文档
3. **社区支持**: 在 GitHub 或社区论坛提问
4. **调试模式**: 启用调试模式查看详细信息

---

*本手册基于 gin-vue-admin 数据权限插件 v1.0.0 编写，如有更新请参考最新版本文档。*